<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="icon" href="data:,">
    <title>Preview Open DB</title>
</head>
<body>
    <button class="bt-delete">delete db</button>

    <!--inject:start-->
    <script src="../dist/open-db.js"></script>
    <!--inject:end-->

    <script>
        const {
            openDB, deleteDB, getDBs
        } = window['open-db'];

        const dbName = 'db';
        const defaultStoreName = 'store-default-key-value';

        document.querySelector('.bt-delete').addEventListener('click', async () => {
            const error = await deleteDB(dbName);
            console.log('deleteDB', error);
        });

        const uid = function(len = 8, prefix = '') {
            const dict = '0123456789abcdefghijklmnopqrstuvwxyz';
            const dictLen = dict.length;
            let str = prefix;
            while (len--) {
                str += dict[Math.random() * dictLen | 0];
            }
            return str;
        };

        const defaultTest = async () => {
            console.log('=========================================================');
            console.log('default key-value set/get');

            const odb = await openDB(dbName, defaultStoreName);
            console.log('version', odb.db.version);

            let v = await odb.get('key');
            console.log('get key', v);

            await odb.set('key', 'value');
            v = await odb.get('key');
            console.log('get key', v);
            console.assert(v === 'value');

            await odb.set('key', 'value2');
            v = await odb.get('key');
            console.log('get key', v);
            console.assert(v === 'value2');


            await odb.set('id', 'id-value');
            v = await odb.get('id');
            console.log('get id', v);
            console.assert(v === 'id-value');

            let count = await odb.count();
            console.log('count', count);
            console.assert(count === 2);

            const obj = {
                id: 'id-value',
                name: 'name-value',
                age: 'age-value'
            };
            await odb.set('obj', obj);
            v = await odb.get('obj');
            console.log('get obj', v);
            console.assert(JSON.stringify(v) === JSON.stringify(obj));

            count = await odb.count();
            console.log('count', count);
            console.assert(count === 3);

            await odb.delete('obj');
            v = await odb.get('obj');
            console.log('get obj after delete', v);
            console.assert(typeof v === 'undefined');

            count = await odb.count();
            console.log('count', count);
            console.assert(count === 2);

            console.log('each');
            await odb.each((item, i) => {
                console.log(i, item);
            });

            await odb.clear();
            v = await odb.get('key');
            console.log('get key after clear', v);
            console.assert(typeof v === 'undefined');
            count = await odb.count();
            console.log('count', count);
            console.assert(count === 0);

            console.log('close db');
            odb.close();
            //console.log(odb);
        };

        const keyPathTest = async () => {
            console.log('=========================================================');
            console.log('keyPath id');
            const odb = await openDB(dbName, 'store-key-path-id', 'id');
            console.log('version', odb.db.version);

            const obj = {
                id: 'id',
                name: 'name'
            };
            await odb.set(obj);
            console.log('set', obj);
        
            let v = await odb.get('id');
            console.log('get id', v);
            console.assert(JSON.stringify(v) === JSON.stringify(obj));
            console.assert(v.name === 'name');

            console.log('each');
            await odb.each((item, i) => {
                console.log(i, item);
            });

            await odb.delete('id');

            v = await odb.get('id');
            console.log('get id after delete', v);
            console.assert(typeof v === 'undefined');

        };

        const autoIncrementTest = async () => {
            console.log('=========================================================');
            console.log('autoIncrement true');

            const odb = await openDB(dbName, 'store-auto-increment-true', true);
            console.log('version', odb.db.version);

            let v = await odb.get('key');
            console.log('get key', v);

            const obj = {
                id: uid(4, 'id-'),
                value: uid(10, 'name-')
            };
            const r = await odb.add(obj);
            if (r.error) {
                console.error(r.error);
            }
            console.log('add', obj);
        
            v = await odb.get(1);
            console.log('get key', v);

            await odb.put({
                id: 'id-1'
            }, 1);

            v = await odb.get(1);
            console.log('get key after put', v);
            console.assert(v.id === 'id-1');

            const count = await odb.count();
            console.log('count', count);

            const all = await odb.getAll();
            console.log('getAll', all);
            console.assert(all.length === count);

            console.log('each');
            await odb.each((item, i) => {
                console.log(i, item);
            });

            console.log('clear');
            await odb.clear();

            //console.log('close db');
            //odb.close();
        };

        const indexTest = async () => {
            console.log('=========================================================');
            console.log('index id and name');

            const storeName = 'store-index-name';
            const odb = await openDB(dbName, storeName, {
                keyPath: 'id',
                index: {
                    id: {
                        unique: true
                    },
                    name: {
                        unique: false
                    }
                }
            });

            await odb.put({
                id: 'id-1',
                name: 'name-1'
            });

            await odb.put({
                id: 'id-2',
                name: 'name-2'
            });

            await odb.put({
                id: 'id-3',
                name: 'Tom And Jerry'
            });

            let v = await odb.get('Tom And Jerry', 'name');
            console.log('get by index name', 'Tom And Jerry', v);

            v = await odb.get('id-1', 'id');
            console.log('get by index id', 'id-1', v);

            v = await odb.get('id-1');
            console.log('get by keyPath id', 'id-1', v);

            console.log('each');
            await odb.each((item, i) => {
                console.log(i, item);
            });

        };

        const storeTest = async () => {

            console.log('=========================================================');
            console.log('store');

            const storeName = defaultStoreName;
            const odb = await openDB(dbName, storeName);

            console.log('getStoreNames', odb.getStoreNames());
            const storeNum = odb.getStoreNames().length;
            console.log('storeNum', storeNum);

            let hasStore = await odb.hasStore(storeName);
            console.log('hasStore', storeName, hasStore);
            console.assert(hasStore === true);

            const storeNameNew1 = 'store-key-value-new-1';
            await odb.createStore(storeNameNew1);
            console.log('createStore', storeNameNew1);
            console.assert(odb.storeName === storeNameNew1);

            const storeNameNew2 = 'store-key-value-new-2';
            await odb.createStore(storeNameNew2);
            console.log('createStore', storeNameNew2);
            console.assert(odb.storeName === storeNameNew2);

            console.log('getStoreNames', odb.getStoreNames());
            console.assert(odb.getStoreNames().length === storeNum + 2);

            console.log('deleteStore no name');
            await odb.deleteStore();

            console.log('deleteStore wrong name');
            await odb.deleteStore('wrongName');

            console.log('deleteStore', storeNameNew1);
            await odb.deleteStore(storeNameNew1);
        
            hasStore = await odb.hasStore(storeNameNew1);
            console.log('hasStore', storeNameNew1, hasStore);
            console.assert(hasStore === false);

            console.log('getStoreNames', odb.getStoreNames());
            console.assert(odb.getStoreNames().length === storeNum + 1);

            console.log('deleteStore', storeNameNew2);
            await odb.deleteStore(storeNameNew2);
        
            hasStore = await odb.hasStore(storeNameNew2);
            console.log('hasStore', storeNameNew2, hasStore);
            console.assert(hasStore === false);

            await odb.useStore(storeName);
            console.log('useStore', storeName);
            console.assert(odb.storeName === storeName);

            console.log('getStoreNames', odb.getStoreNames());
            console.assert(odb.getStoreNames().length === storeNum);
        
        };

        //console.log(openDB);
        const async = async () => {

            console.log('getDBs', await getDBs());

            await defaultTest();

            await keyPathTest();
        
            await autoIncrementTest();

            await indexTest();
        
            await storeTest();

        };

        async();

    </script>
</body>
</html>
