<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="icon" href="data:,">
    <title>Preview Open DB</title>
</head>
<body>
    <button class="bt-delete">delete db</button>

    <!--inject:start-->
    <script src="../dist/open-db.js"></script>
    <!--inject:end-->

    <script>
        const {
            openDB, deleteDB, getDBs
        } = window['open-db'];

        const dbName = 'db';
        const defaultStoreName = 'store-default-key-value';

        document.querySelector('.bt-delete').addEventListener('click', async () => {
            const error = await deleteDB(dbName);
            console.log('deleteDB', error);
        });

        const uid = function(len = 8, prefix = '') {
            const dict = '0123456789abcdefghijklmnopqrstuvwxyz';
            const dictLen = dict.length;
            let str = prefix;
            while (len--) {
                str += dict[Math.random() * dictLen | 0];
            }
            return str;
        };

        const defaultTest = async () => {
            console.log('=========================================================');
            console.log('default key-value setItem/getItem');

            const odb = await openDB(dbName, defaultStoreName);
            console.log('version', odb.db.version);

            let v = await odb.getItem('key');
            console.log('getItem key', v);

            await odb.setItem('key', 'value');
            v = await odb.getItem('key');
            console.log('getItem key', v);
            console.assert(v === 'value');

            await odb.setItem('key', 'value2');
            v = await odb.getItem('key');
            console.log('getItem key', v);
            console.assert(v === 'value2');


            await odb.setItem('id', 'id-value');
            v = await odb.getItem('id');
            console.log('getItem id', v);
            console.assert(v === 'id-value');

            let count = await odb.count();
            console.log('count', count);
            console.assert(count === 2);

            const obj = {
                id: 'id-value',
                name: 'name-value',
                age: 'age-value'
            };
            await odb.setItem('obj', obj);
            v = await odb.getItem('obj');
            console.log('getItem obj', v);
            console.assert(JSON.stringify(v) === JSON.stringify(obj));

            count = await odb.count();
            console.log('count', count);
            console.assert(count === 3);

            await odb.deleteItem('obj');
            v = await odb.getItem('obj');
            console.log('getItem obj after deleteItem', v);
            console.assert(typeof v === 'undefined');

            count = await odb.count();
            console.log('count', count);
            console.assert(count === 2);

            await odb.clear();
            v = await odb.getItem('key');
            console.log('getItem key after clear', v);
            console.assert(typeof v === 'undefined');
            count = await odb.count();
            console.log('count', count);
            console.assert(count === 0);

            console.log('close db');
            odb.close();
            //console.log(odb);
        };

        const keyPathTest = async () => {
            console.log('=========================================================');
            console.log('keyPath id');
            const odb = await openDB(dbName, 'store-key-path-id', 'id');
            console.log('version', odb.db.version);

            const obj = {
                id: 'id',
                name: 'name'
            };
            await odb.setItem(obj);
            console.log('setItem', obj);
        
            let v = await odb.getItem('id');
            console.log('getItem id', v);
            console.assert(JSON.stringify(v) === JSON.stringify(obj));
            console.assert(v.name === 'name');

            await odb.deleteItem('id');

            v = await odb.getItem('id');
            console.log('getItem id after deleteItem', v);
            console.assert(typeof v === 'undefined');
        };

        const autoIncrementTest = async () => {
            console.log('=========================================================');
            console.log('autoIncrement true');

            const odb = await openDB(dbName, 'store-auto-increment-true', true);
            console.log('version', odb.db.version);

            let v = await odb.getItem('key');
            console.log('getItem key', v);

            const obj = {
                id: uid(4, 'id-'),
                value: uid(10, 'name-')
            };
            const r = await odb.addItem(obj);
            if (r.error) {
                console.error(r.error);
            }
            console.log('addItem', obj);
        
            v = await odb.getItem(1);
            console.log('getItem key', v);

            await odb.putItem({
                id: 'id-1'
            }, 1);

            v = await odb.getItem(1);
            console.log('getItem key after putItem', v);
            console.assert(v.id === 'id-1');

            console.log('count', await odb.count());

            //await odb.clear();

            //console.log('close db');
            //odb.close();
        };

        const storeTest = async () => {

            console.log('=========================================================');
            console.log('store');

            const storeName = defaultStoreName;
            let odb = await openDB(dbName, storeName);

            console.log('getStoreNames', odb.getStoreNames());
            console.assert(odb.getStoreNames().length === 3);

            let hasStore = await odb.hasStore(storeName);
            console.log(`hasStore ${storeName} ${hasStore}`);
            console.assert(hasStore === true);

            console.log('deleteStore no name');
            await odb.deleteStore();

            console.log('deleteStore wrong name');
            await odb.deleteStore('wrongName');

            console.log(`deleteStore current name: ${storeName}`);
            await odb.deleteStore(storeName);
            hasStore = await odb.hasStore(storeName);
            console.log(`hasStore ${storeName} ${hasStore}`);
            console.assert(hasStore === true);


            const storeNameNew = 'store-key-value-new';
            odb = await openDB(dbName, storeNameNew);
            console.assert(odb.storeName === storeNameNew);

            console.log('getStoreNames', odb.getStoreNames());
            console.assert(odb.getStoreNames().length === 4);

            await odb.useStore(storeName);
            console.log(`useStore ${storeName}`);
            console.assert(odb.storeName === storeName);

            console.log(`deleteStore: ${storeNameNew}`);
            await odb.deleteStore(storeNameNew);
            hasStore = await odb.hasStore(storeNameNew);
            console.log(`hasStore ${storeNameNew} ${hasStore}`);
            console.assert(hasStore === false);

            console.log('getStoreNames', odb.getStoreNames());
            console.assert(odb.getStoreNames().length === 3);
        

        };

        //console.log(openDB);
        const async = async () => {

            console.log('getDBs', await getDBs());

            await defaultTest();

            await keyPathTest();
        
            await autoIncrementTest();
        
            await storeTest();

        };

        async();

    </script>
</body>
</html>
