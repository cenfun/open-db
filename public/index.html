<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0">
    <link rel="icon" href="data:,">
    <title>Preview Open DB</title>
</head>
<body>
    <button class="bt-delete">delete db</button>

    <!--inject:start-->
    <script src="../dist/open-db.js"></script>
    <!--inject:end-->

    <script>
        const {
            openDB, deleteDB, dbs
        } = window['open-db'];

        const dbName = 'db';

        document.querySelector('.bt-delete').addEventListener('click', async () => {
            const error = await deleteDB(dbName);
            console.log('deleteDB', error);
        });

        const defaultTest = async () => {
            console.log('=========================================================');
            console.log('default key-value setItem/getItem');

            const odb = await openDB(dbName, 'store-key-value');
            console.log(odb.db.version);

            let v = await odb.getItem('key');
            console.log('getItem key', v);

            await odb.setItem('key', 'value');
            v = await odb.getItem('key');
            console.log('getItem key', v);
            console.assert(v === 'value');

            await odb.setItem('key', 'value2');
            v = await odb.getItem('key');
            console.log('getItem key', v);
            console.assert(v === 'value2');


            await odb.setItem('id', 'id-value');
            v = await odb.getItem('id');
            console.log('getItem id', v);
            console.assert(v === 'id-value');

            const obj = {
                id: 'id-value',
                name: 'name-value',
                age: 'age-value'
            };
            await odb.setItem('obj', obj);
            v = await odb.getItem('obj');
            console.log('getItem obj', v);
            console.assert(JSON.stringify(v) === JSON.stringify(obj));

            await odb.removeItem('obj');
            v = await odb.getItem('obj');
            console.log('getItem obj after removeItem', v);
            console.assert(typeof v === 'undefined');

            await odb.clear();
            v = await odb.getItem('key');
            console.log('getItem key after clear', v);
            console.assert(typeof v === 'undefined');

            console.log('close db');
            odb.close();
            //console.log(odb);
        };

        const keyPathTest = async () => {
            console.log('=========================================================');
            console.log('keyPath id');
            const odb = await openDB(dbName, 'store-id-name', {
                keyPath: 'id'
            });
            console.log(odb.db.version);

            await odb.setItem({
                id: 'id',
                name: 'name'
            });
            const v = await odb.getItem('id');
            console.log('getItem id', v);
            console.assert(v.name === 'name');
        };

        const autoIncrementTest = async () => {
            console.log('=========================================================');
            console.log('autoIncrement true');

            const odb = await openDB(dbName, 'store-auto-increment', true);
            console.log(odb.db.version);

            let v = await odb.getItem('key');
            console.log('getItem key', v);

            const r = await odb.addItem({
                value: 'value',
                id: 'id1'
            });
            if (r.error) {
                console.error(r.error);
            }
        
            v = await odb.getItem(0);
            console.log('getItem key', v);

            //await odb.clear();

            //console.log('close db');
            //odb.close();
        };

        const storeTest = async () => {

            const storeName = 'store-key-value';
            let odb = await openDB(dbName, storeName);

            console.assert(odb.storeNames().length === 3);

            let hasStore = await odb.hasStore(storeName);
            console.log(`hasStore ${storeName} ${hasStore}`);
            console.assert(hasStore === true);

            console.log('deleteStore no name');
            await odb.deleteStore();

            console.log('deleteStore wrong name');
            await odb.deleteStore('wrongName');

            console.log(`deleteStore current name: ${storeName}`);
            await odb.deleteStore(storeName);
            hasStore = await odb.hasStore(storeName);
            console.log(`hasStore ${storeName} ${hasStore}`);
            console.assert(hasStore === true);


            const storeNameNew = 'store-key-value-new';
            odb = await openDB(dbName, storeNameNew);
            console.assert(odb.storeName === storeNameNew);
            console.assert(odb.storeNames().length === 4);

            await odb.useStore(storeName);
            console.log(`useStore ${storeName}`);
            console.assert(odb.storeName === storeName);

            console.log(`deleteStore: ${storeNameNew}`);
            await odb.deleteStore(storeNameNew);
            hasStore = await odb.hasStore(storeNameNew);
            console.log(`hasStore ${storeNameNew} ${hasStore}`);
            console.assert(hasStore === false);
            console.assert(odb.storeNames().length === 3);
        

        };

        //console.log(openDB);
        const async = async () => {

            console.log('all dbs', await dbs());

            await defaultTest();

            await keyPathTest();
        
            await autoIncrementTest();
        
            await storeTest();

        };

        async();

    </script>
</body>
</html>
